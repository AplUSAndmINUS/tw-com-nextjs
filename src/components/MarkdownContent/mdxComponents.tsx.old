'use client';

/**
 * MDX component overrides for TW.com
 * ====================================
 *
 * Maps every Markdown/MDX element to the Fluent UI typography system defined
 * in fluentTheme.ts.  Colour tokens come from the CSS custom properties that
 * FluentUI's FluentProvider sets on the root element, so the map automatically
 * respects all 8 theme variants (light, dark, high-contrast, colourblind, …)
 * without needing to call useAppTheme() on every render.
 *
 * Usage — pass to MDXRemote in any content page:
 * ```tsx
 * import { mdxComponents } from '@/components/MarkdownContent';
 * <MDXRemote source={post.content} components={mdxComponents} />
 * ```
 */

import React from 'react';
import Image from 'next/image';
import Link from 'next/link';
import { Typography } from '@/components/Typography';
import type { MDXComponents } from 'mdx/types';

// ---------------------------------------------------------------------------
// FluentUI semantic-colour CSS variables
// These are set on the FluentProvider DOM node and update automatically when
// the user switches theme.
// ---------------------------------------------------------------------------
const fg1 = 'var(--colorNeutralForeground1)';
const fg2 = 'var(--colorNeutralForeground2)';
const brandLink = 'var(--colorBrandForegroundLink)';
const strokeColor = 'var(--colorNeutralStroke1)';
const codeBg = 'var(--colorNeutralBackground3)';
const preBg = 'var(--colorNeutralBackground4)';
const blockquoteBorder = 'var(--colorBrandBackground)';

// ---------------------------------------------------------------------------
// Heading spacing helpers — provide comfortable rhythm between blocks
// ---------------------------------------------------------------------------
const headingMargins = {
  h1: { marginTop: '2rem', marginBottom: '1rem' },
  h2: { marginTop: '1.75rem', marginBottom: '0.875rem' },
  h3: { marginTop: '1.5rem', marginBottom: '0.75rem' },
  h4: { marginTop: '1.25rem', marginBottom: '0.625rem' },
  h5: { marginTop: '1rem', marginBottom: '0.5rem' },
  h6: { marginTop: '1rem', marginBottom: '0.5rem' },
};

// ---------------------------------------------------------------------------
// MDX component map
// ---------------------------------------------------------------------------
export const mdxComponents: MDXComponents = {
  // ── Headings ────────────────────────────────────────────────────────────
  h1: ({ children }) => (
    <Typography
      variant='h1'
      color={fg1}
      marginTop={headingMargins.h1.marginTop}
      marginBottom={headingMargins.h1.marginBottom}
    >
      {children}
    </Typography>
  ),

  h2: ({ children }) => (
    <Typography
      variant='h2'
      color={fg1}
      marginTop={headingMargins.h2.marginTop}
      marginBottom={headingMargins.h2.marginBottom}
    >
      {children}
    </Typography>
  ),

  h3: ({ children }) => (
    <Typography
      variant='h3'
      color={fg1}
      marginTop={headingMargins.h3.marginTop}
      marginBottom={headingMargins.h3.marginBottom}
    >
      {children}
    </Typography>
  ),

  h4: ({ children }) => (
    <Typography
      variant='h4'
      color={fg1}
      marginTop={headingMargins.h4.marginTop}
      marginBottom={headingMargins.h4.marginBottom}
    >
      {children}
    </Typography>
  ),

  h5: ({ children }) => (
    <Typography
      variant='h5'
      color={fg2}
      marginTop={headingMargins.h5.marginTop}
      marginBottom={headingMargins.h5.marginBottom}
    >
      {children}
    </Typography>
  ),

  h6: ({ children }) => (
    <Typography
      variant='h6'
      color={fg2}
      marginTop={headingMargins.h6.marginTop}
      marginBottom={headingMargins.h6.marginBottom}
    >
      {children}
    </Typography>
  ),

  // ── Body paragraph ───────────────────────────────────────────────────────
  // Typography variant 'body' renders using the theme's body font definition.
  p: ({ children }) => (
    <Typography variant='body' color={fg1} marginBottom='1rem'>
      {children}
    </Typography>
  ),

  // ── Blockquote ───────────────────────────────────────────────────────────
  blockquote: ({ children }) => (
    <blockquote
      style={{
        borderLeft: `4px solid ${blockquoteBorder}`,
        paddingLeft: '1rem',
        marginLeft: 0,
        marginRight: 0,
        marginTop: '1rem',
        marginBottom: '1rem',
        color: fg2,
        fontStyle: 'italic',
      }}
    >
      {children}
    </blockquote>
  ),

  // ── Code blocks (fenced ```) ─────────────────────────────────────────────
  pre: ({ children }) => (
    <pre
      style={{
        background: preBg,
        borderRadius: '0.5rem',
        padding: '1rem',
        overflowX: 'auto',
        marginTop: '0.5rem',
        marginBottom: '1.25rem',
      }}
    >
      {children}
    </pre>
  ),

  // ── Inline code and code-block inner element ─────────────────────────────
  // When className is present (language-xxx) the element is inside a <pre>
  // code block — skip the inline-code pill styling in that case.
  code: ({ children, className }) =>
    className ? (
      <code className={className} style={{ color: fg1 }}>
        {children}
      </code>
    ) : (
      <Typography
        variant='code'
        color={fg1}
        className={className}
        style={{
          background: codeBg,
          borderRadius: '0.25rem',
          padding: '0.125rem 0.375rem',
        }}
      >
        {children}
      </Typography>
    ),

  // ── Lists ────────────────────────────────────────────────────────────────
  ul: ({ children }) => (
    <ul
      style={{
        color: fg1,
        paddingLeft: '1.5rem',
        marginBottom: '1rem',
        listStyleType: 'disc',
      }}
    >
      {children}
    </ul>
  ),

  ol: ({ children }) => (
    <ol
      style={{
        color: fg1,
        paddingLeft: '1.5rem',
        marginBottom: '1rem',
        listStyleType: 'decimal',
      }}
    >
      {children}
    </ol>
  ),

  li: ({ children }) => (
    <li style={{ color: fg1, marginBottom: '0.25rem' }}>{children}</li>
  ),

  // ── Anchor / link ────────────────────────────────────────────────────────
  // Internal links (starting with /) use Next.js Link for client-side routing.
  // External links open in a new tab with rel="noopener noreferrer".
  a: ({ href, children, ...props }) => {
    const isInternal = href && (href.startsWith('/') || href.startsWith('#'));
    const linkStyle = { color: brandLink, textDecoration: 'underline' };
    if (isInternal) {
      return (
        <Link href={href} style={linkStyle} {...props}>
          {children}
        </Link>
      );
    }
    return (
      <a
        href={href}
        target='_blank'
        rel='noopener noreferrer'
        style={linkStyle}
        {...props}
      >
        {children}
      </a>
    );
  },

  // ── Inline image (embedded in markdown body) ─────────────────────────────
  // Uses next/image with unoptimized flag (required for static export).
  // Falls back gracefully when src is missing.
  // Note: when alt is empty the image is treated as decorative (role="none").
  img: ({ src, alt }) =>
    src ? (
      <span style={{ display: 'block', marginBottom: '1.25rem' }}>
        <Image
          src={src}
          alt={alt ?? ''}
          width={800}
          height={450}
          role={alt ? undefined : 'none'}
          style={{ width: '100%', height: 'auto', borderRadius: '0.5rem' }}
          unoptimized
        />
        {alt && (
          <Typography
            variant='caption'
            color={fg2}
            textAlign='center'
            marginTop='0.375rem'
            style={{ display: 'block' }}
          >
            {alt}
          </Typography>
        )}
      </span>
    ) : null,

  // ── Horizontal rule ──────────────────────────────────────────────────────
  hr: () => (
    <hr
      style={{
        border: 'none',
        borderTop: `1px solid ${strokeColor}`,
        marginTop: '2rem',
        marginBottom: '2rem',
      }}
    />
  ),

  // ── Inline emphasis ──────────────────────────────────────────────────────
  strong: ({ children }) => (
    <strong style={{ color: fg1, fontWeight: 700 }}>{children}</strong>
  ),

  em: ({ children }) => (
    <em style={{ color: fg1, fontStyle: 'italic' }}>{children}</em>
  ),

  // ── Tables ───────────────────────────────────────────────────────────────
  table: ({ children }) => (
    <div style={{ overflowX: 'auto', marginBottom: '1rem' }}>
      <table style={{ width: '100%', borderCollapse: 'collapse', color: fg1 }}>
        {children}
      </table>
    </div>
  ),

  th: ({ children }) => (
    <th
      style={{
        padding: '0.5rem 0.75rem',
        textAlign: 'left',
        fontWeight: 600,
        borderBottom: `2px solid ${strokeColor}`,
        color: fg1,
      }}
    >
      {children}
    </th>
  ),

  td: ({ children }) => (
    <td
      style={{
        padding: '0.5rem 0.75rem',
        borderBottom: `1px solid var(--colorNeutralStroke2)`,
        color: fg1,
      }}
    >
      {children}
    </td>
  ),
};
